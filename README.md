# TeSS Scrapers

## About

These are a collection of Ruby scripts designed to scrape web pages (or other useful resources) and create Events or Materials on the TeSS website, https://tess.elixir-uk.org. They require the TeSS API client
in order to function: https://github.com/ElixirUK/TeSS_api_client.

## Running


Install all depending gems for the tess_api_client gem using bundler by running this command in the root directory:

`bundle install`

Then install the tessdata gem. From the root directory, run:

`sh build.sh`

Note that you may have to install the gems listed in the Gemfile, e.g.:

`gem install nokogiri`

From the root directory copy the example_uploader_config.txt into uploader_config.txt with the command:

`cp example_uploader_config.txt uploader_config.txt`

and configure appropriately to your TeSS instance.

You have an *authentication token* generated by TeSS when you sign up for an account. Go to your profile page on TeSS and copy the secret token into the corresponding field on uploader_config.txt.

To run a scraper simply run `ruby <scraper_name>.rb`. For example:

`ruby ebi_scraper.rb`

## Writing

The scraper scripts all follow a very similar format:

1. A page or pages are supplied to the scraper, which are downloaded and parsed.
2. The data from (1) are added to a $lessons object.
3. Once the parsing is finished then $lessons from (2) are converted into Materials or Events and uploaded.

Looking at the source of any of the scripts contained in this repository ought to give a good indication of their function.


### Variables

The following variables are defined in each scraper script:

    $root_url = 'https://awesome-training-materials/biosciences'
    $owner_org = 'awesome-training'
    $lessons = {}
    $debug = ScraperConfig.debug?


The $root_url is the main page listing training materials. After parsing this it may be necessary to follow each of the
links on it during the parsing step to get additional information from them. The $debug variable can be used in testing by
downloading the html page to be parsed and opening that rather than hitting the remote site, to avoid bothering content
providers with spurious log entries. The value is defined in the uploader_config.txt file.

### Parsing

Here's an example of some basic parsing code:

    doc = Nokogiri::HTML(open($root_url + page))
    doc.xpath('//h3').each do |record|
        url = record['href']
        name = record.content
        $lessons[url] = {}
        $lessons[url]['name'] = name
    end

This uses the URL of a training material as the key in a hash which is used to store its parameters; in this example only the material's name is stored,
but the same principle should be used for any other fields.



### Uploading

The $lessons hash can be used to construct data objects suitable for posting to TeSS:

    $lessons.each_key do |key|
        material = Material.new({title: $lessons[key]['name'],
                                 url: key,
                                 short_description: $lessons[key]['short_description'],
                                 doi: nil,
                                 remote_updated_date: Time.now,
                                 remote_created_date: nil,
                                 content_provider_id: cp['id'],
                                 scientific_topic: [],
                                 keywords:[]})

          Uploader.create_or_update_material(material)
    end

Please refer to the further examples in the TeSS API repository:

https://github.com/ElixirUK/TeSS_api_client

